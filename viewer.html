<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>DCC // VIEWER</title>
  <style>
    :root { color-scheme: dark; }
    html, body { height: 100%; margin: 0; background: #050805; color: #8fffa0; }
    body { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .bar{
      position: sticky; top: 0; z-index: 1000;
      display: flex; gap: 8px; align-items: center; justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(64,255,106,.22);
      background: rgba(0,0,0,.92);
    }
    .leftBtns, .rightBtns { display: flex; gap: 8px; align-items: center; }
    .title { font-size: 12px; opacity: .9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 42vw; }
    .btn{
      border: 1px solid rgba(64,255,106,.22);
      background: rgba(64,255,106,.10);
      color: #8fffa0;
      padding: 10px 12px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .5px;
      cursor: pointer;
      min-height: 44px;
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .hint{ font-size: 11px; opacity:.7; }
    a { color: #8fffa0; }

    .stage{
      height: calc(100dvh - 62px);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      display: grid;
      place-items: start center;
      padding: 12px;
    }
    canvas{
      max-width: 100%;
      height: auto;
      border: 1px solid rgba(64,255,106,.18);
      background: #000;
      box-shadow: 0 0 18px rgba(0,0,0,.55);
    }
    .err{
      position: sticky;
      top: 62px;
      margin: 0;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,120,120,.35);
      background: rgba(80,0,0,.45);
      color: rgba(255,190,190,1);
      font-size: 12px;
      display: none;
      z-index: 999;
    }
    .ok{
      position: sticky;
      top: 62px;
      margin: 0;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(64,255,106,.22);
      background: rgba(0,60,0,.35);
      color: rgba(180,255,210,1);
      font-size: 12px;
      display: none;
      z-index: 999;
    }
    .mono { white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="bar">
    <div class="leftBtns">
      <button class="btn" id="backBtn">‚Üê Back</button>
      <button class="btn" id="prevBtn">Prev</button>
      <button class="btn" id="nextBtn">Next</button>
    </div>

    <div class="title" id="docTitle">VIEWER</div>

    <div class="rightBtns">
      <button class="btn" id="zoomOut">-</button>
      <div class="hint" id="pageInfo">PAGE ?/?</div>
      <button class="btn" id="zoomIn">+</button>
      <a class="hint" id="openNative" target="_blank" rel="noopener">Open PDF</a>
    </div>
  </div>

  <div class="ok" id="okBox"></div>
  <div class="err" id="errBox"></div>

  <div class="stage">
    <canvas id="pdfCanvas"></canvas>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const file = params.get("file");
    const name = params.get("name") || "DOCUMENT";

    const docTitle = document.getElementById("docTitle");
    const openNative = document.getElementById("openNative");
    const pageInfo = document.getElementById("pageInfo");
    const okBox = document.getElementById("okBox");
    const errBox = document.getElementById("errBox");
    const canvas = document.getElementById("pdfCanvas");
    const ctx = canvas.getContext("2d");

    docTitle.textContent = name;
    if (file) openNative.href = file;

    function showErr(msg){
      errBox.style.display = "block";
      errBox.innerHTML = "<div class='mono'>" + msg.replace(/</g,"&lt;") + "</div>";
    }
    function showOk(msg){
      okBox.style.display = "block";
      okBox.innerHTML = "<div class='mono'>" + msg.replace(/</g,"&lt;") + "</div>";
      setTimeout(()=>{ okBox.style.display="none"; }, 2500);
    }

    document.getElementById("backBtn").addEventListener("click", () => {
      // always works
      location.href = "index.html";
    });

    if (!file){
      showErr("NO FILE SPECIFIED.\n\nTry:\nviewer.html?file=doc/00_START_HERE/000_READ_THIS_FIRST.pdf&name=READ_THIS_FIRST");
      pageInfo.textContent = "NO FILE";
      throw new Error("No file= parameter provided.");
    }

    // ---- Load PDF.js with fallbacks ----
    async function loadScript(src){
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.onload = resolve;
        s.onerror = () => reject(new Error("Failed to load: " + src));
        document.head.appendChild(s);
      });
    }

    const PDFJS_CANDIDATES = [
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.min.js",
      "https://unpkg.com/pdfjs-dist@4.10.38/build/pdf.min.js"
    ];

    const WORKER_CANDIDATES = [
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.worker.min.js",
      "https://unpkg.com/pdfjs-dist@4.10.38/build/pdf.worker.min.js"
    ];

    let pdfjsLib = null;
    let workerSrc = null;

    async function bootPdfJs(){
      let lastErr = null;

      for (let i=0; i<PDFJS_CANDIDATES.length; i++){
        try{
          await loadScript(PDFJS_CANDIDATES[i]);
          if (window.pdfjsLib){
            pdfjsLib = window.pdfjsLib;
            workerSrc = WORKER_CANDIDATES[i] || WORKER_CANDIDATES[0];
            pdfjsLib.GlobalWorkerOptions.workerSrc = workerSrc;
            showOk("PDF.js loaded.");
            return;
          }
        } catch(e){
          lastErr = e;
        }
      }

      throw lastErr || new Error("PDF.js failed to load.");
    }

    // ---- Render logic ----
    let pdfDoc = null;
    let pageNum = 1;
    let scale = 1.2;
    let rendering = false;

    function clampScale(s){ return Math.max(0.6, Math.min(3.0, s)); }

    async function renderPage(num){
      if (!pdfDoc || rendering) return;
      rendering = true;

      const page = await pdfDoc.getPage(num);

      // fit to width
      const viewport1 = page.getViewport({ scale: 1 });
      const stageWidth = document.querySelector(".stage").clientWidth - 24;
      const fitScale = stageWidth / viewport1.width;
      const useScale = clampScale(scale * fitScale);

      const vp = page.getViewport({ scale: useScale });

      canvas.width = Math.floor(vp.width);
      canvas.height = Math.floor(vp.height);

      await page.render({ canvasContext: ctx, viewport: vp }).promise;

      pageInfo.textContent = `PAGE ${pageNum}/${pdfDoc.numPages}`;
      document.getElementById("prevBtn").disabled = (pageNum <= 1);
      document.getElementById("nextBtn").disabled = (pageNum >= pdfDoc.numPages);

      rendering = false;
    }

    async function loadPdf(){
      pageInfo.textContent = "LOADING...";
      // quick file reachability check (shows path/case issues)
      try{
        const res = await fetch(file, { method: "GET" });
        if (!res.ok){
          throw new Error("HTTP " + res.status + " for " + file);
        }
      } catch(e){
        showErr(
          "CANNOT FETCH PDF.\n\n" +
          "This is usually a PATH or CASE mismatch.\n" +
          "Requested:\n  " + file + "\n\n" +
          "Try opening the PDF link:\n  " + file + "\n\n" +
          "Error:\n  " + e.message
        );
        pageInfo.textContent = "FETCH FAILED";
        throw e;
      }

      pdfDoc = await pdfjsLib.getDocument({ url: file }).promise;
      pageNum = 1;
      await renderPage(pageNum);
    }

    document.getElementById("prevBtn").addEventListener("click", async () => {
      if (pageNum <= 1) return;
      pageNum--;
      await renderPage(pageNum);
    });

    document.getElementById("nextBtn").addEventListener("click", async () => {
      if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
      pageNum++;
      await renderPage(pageNum);
    });

    document.getElementById("zoomIn").addEventListener("click", async () => {
      scale = clampScale(scale + 0.15);
      await renderPage(pageNum);
    });

    document.getElementById("zoomOut").addEventListener("click", async () => {
      scale = clampScale(scale - 0.15);
      await renderPage(pageNum);
    });

    window.addEventListener("resize", () => { if (pdfDoc) renderPage(pageNum); });

    (async function main(){
      try{
        await bootPdfJs();
        await loadPdf();
      } catch(e){
        showErr(
          "VIEWER FAILED TO START.\n\n" +
          "Likely causes:\n" +
          "1) PDF.js CDN blocked (try different network)\n" +
          "2) Worker blocked\n" +
          "3) PDF path/case mismatch\n\n" +
          "Details:\n" + (e && e.message ? e.message : String(e))
        );
      }
    })();
  </script>
</body>
</html>
