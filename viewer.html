<<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>DCC // VIEWER</title>
  <style>
    :root { color-scheme: dark; }
    html, body { height: 100%; margin: 0; background: #050805; color: #8fffa0; }
    body { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .bar{
      position: sticky; top: 0; z-index: 1000;
      display: flex; gap: 8px; align-items: center; justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(64,255,106,.22);
      background: rgba(0,0,0,.92);
    }
    .leftBtns, .rightBtns { display: flex; gap: 8px; align-items: center; }
    .title { font-size: 12px; opacity: .9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 42vw; }

    .btn{
      border: 1px solid rgba(64,255,106,.22);
      background: rgba(64,255,106,.10);
      color: #8fffa0;
      padding: 10px 12px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .5px;
      cursor: pointer;
      min-height: 44px;
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .hint{ font-size: 11px; opacity:.7; }
    a { color: #8fffa0; }

    .stage{
      height: calc(100dvh - 62px);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      display: grid;
      place-items: start center;
      padding: 12px;
    }
    canvas{
      max-width: 100%;
      height: auto;
      border: 1px solid rgba(64,255,106,.18);
      background: #000;
      box-shadow: 0 0 18px rgba(0,0,0,.55);
    }
  </style>
</head>
<body>
  <div class="bar">
    <div class="leftBtns">
      <button class="btn" id="backBtn">‚Üê Back</button>
      <button class="btn" id="prevBtn">Prev</button>
      <button class="btn" id="nextBtn">Next</button>
    </div>

    <div class="title" id="docTitle">VIEWER</div>

    <div class="rightBtns">
      <button class="btn" id="zoomOut">-</button>
      <div class="hint" id="pageInfo">PAGE ?/?</div>
      <button class="btn" id="zoomIn">+</button>
      <a class="hint" id="openNative" target="_blank" rel="noopener">Open PDF</a>
    </div>
  </div>

  <div class="stage">
    <canvas id="pdfCanvas"></canvas>
  </div>

  <!-- PDF.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.min.js"></script>
  <script>
    // ----- Params -----
    const params = new URLSearchParams(location.search);
    const file = params.get("file");
    const name = params.get("name") || "DOCUMENT";

    const docTitle = document.getElementById("docTitle");
    const openNative = document.getElementById("openNative");
    const pageInfo = document.getElementById("pageInfo");
    const canvas = document.getElementById("pdfCanvas");
    const ctx = canvas.getContext("2d");

    docTitle.textContent = name;
    if (file) openNative.href = file;

    // Back button: prefer history, fallback to index
    document.getElementById("backBtn").addEventListener("click", () => {
      if (history.length > 1) history.back();
      else location.href = "index.html";
    });

    // ----- PDF.js setup -----
    if (!file) {
      pageInfo.textContent = "NO FILE";
      throw new Error("No file= parameter provided.");
    }

    // Worker (required)
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.worker.min.js";

    let pdfDoc = null;
    let pageNum = 1;
    let scale = 1.25; // good phone default
    let rendering = false;

    function clampScale(s){
      return Math.max(0.6, Math.min(3.0, s));
    }

    async function renderPage(num){
      if (!pdfDoc || rendering) return;
      rendering = true;

      const page = await pdfDoc.getPage(num);

      // Fit to screen width (with padding)
      const viewport = page.getViewport({ scale: 1 });
      const stageWidth = document.querySelector(".stage").clientWidth - 24;
      const fitScale = stageWidth / viewport.width;

      const useScale = clampScale(scale * fitScale);
      const vp = page.getViewport({ scale: useScale });

      canvas.width = Math.floor(vp.width);
      canvas.height = Math.floor(vp.height);

      await page.render({ canvasContext: ctx, viewport: vp }).promise;

      pageInfo.textContent = `PAGE ${pageNum}/${pdfDoc.numPages}`;

      document.getElementById("prevBtn").disabled = (pageNum <= 1);
      document.getElementById("nextBtn").disabled = (pageNum >= pdfDoc.numPages);

      rendering = false;
    }

    async function load(){
      pageInfo.textContent = "LOADING...";
      pdfDoc = await pdfjsLib.getDocument({ url: file }).promise;
      pageNum = 1;
      await renderPage(pageNum);
    }

    document.getElementById("prevBtn").addEventListener("click", async () => {
      if (pageNum <= 1) return;
      pageNum--;
      await renderPage(pageNum);
    });

    document.getElementById("nextBtn").addEventListener("click", async () => {
      if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
      pageNum++;
      await renderPage(pageNum);
    });

    document.getElementById("zoomIn").addEventListener("click", async () => {
      scale = clampScale(scale + 0.15);
      await renderPage(pageNum);
    });

    document.getElementById("zoomOut").addEventListener("click", async () => {
      scale = clampScale(scale - 0.15);
      await renderPage(pageNum);
    });

    // Re-render on rotate/resize to keep fit
    window.addEventListener("resize", () => {
      if (!pdfDoc) return;
      renderPage(pageNum);
    });

    load();
  </script>
</body>
</html>
